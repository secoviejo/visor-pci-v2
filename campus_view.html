<!DOCTYPE html>
<html lang="es" class="h-full bg-gray-100 dark:bg-gray-900">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vista de Campus - Visor PCI</title>

    <script>
        if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
    <title>Dashboard Campus - Visor PCI</title>
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'zaragoza-blue': '#2E6DA4',
                        'zaragoza-dark': '#333333',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        :root {
            --sidebar-width: 400px;
        }

        .layout-grid {
            display: grid;
            grid-template-columns: 1fr var(--sidebar-width);
            grid-template-rows: 1fr 250px;
            grid-template-areas:
                "map sidebar"
                "alerts alerts";
            height: calc(100vh - 64px - 48px);
            /* Full height - header - breadcrumbs */
        }

        @media (max-width: 768px) {
            .layout-grid {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr 60px;
                grid-template-areas:
                    "map"
                    "alerts";
                height: calc(100vh - 64px - 48px);
            }

            .sidebar-area {
                position: fixed;
                right: 0;
                top: 112px;
                bottom: 108px;
                width: 80% !important;
                z-index: 40;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                border-left: 1px solid #e5e7eb;
            }

            .sidebar-area.active {
                transform: translateX(0);
            }

            .sidebar-resizer {
                display: none;
            }
        }

        .map-area {
            grid-area: map;
            position: relative;
            overflow: hidden;
        }

        .sidebar-area {
            grid-area: sidebar;
            border-left: 1px solid #e5e7eb;
            overflow: hidden;
            /* Allows content under scrollbar if supported, or auto */
            scrollbar-gutter: stable;
            /* Keeps layout stable when scrollbar appears */
            position: relative;
        }

        /* Resizer handle */
        .sidebar-resizer {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 6px;
            background: linear-gradient(to right, transparent, #22c55e, transparent);
            cursor: ew-resize;
            z-index: 100;
            transition: background 0.2s ease;
        }

        .sidebar-resizer:hover,
        .sidebar-resizer.resizing {
            background: linear-gradient(to right, transparent, #16a34a, transparent);
            width: 8px;
        }

        .sidebar-resizer::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 3px;
            height: 40px;
            background: #22c55e;
            border-radius: 2px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .sidebar-resizer:hover::before,
        .sidebar-resizer.resizing::before {
            opacity: 1;
        }

        .alerts-area {
            grid-area: alerts;
            overflow-y: auto;
        }

        .building-marker {
            position: absolute;
            transform: translate(-50%, -50%);
            /* Only transition transform and opacity. NEVER left/top to avoid drag lag. */
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.2s ease, filter 0.2s ease;
            cursor: pointer;
            z-index: 10;
            will-change: transform, left, top;
            user-select: none;
            touch-action: none;
        }

        .building-marker:hover {
            transform: translate(-50%, -50%) scale(1.05);
            z-index: 20;
        }

        .building-marker.is-pressing {
            transform: translate(-50%, -50%) scale(0.95);
            opacity: 0.8;
        }

        .building-marker.is-dragging {
            transition: opacity 0.1s ease !important;
            /* Keep only opacity for smooth start */
            transform: translate(-50%, -50%) scale(1.2);
            -webkit-filter: drop-shadow(0 12px 20px rgba(0, 0, 0, 0.4));
            filter: drop-shadow(0 12px 20px rgba(0, 0, 0, 0.4));
            z-index: 100;
            opacity: 0.85;
        }

        .status-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .marker-label {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
            margin-top: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            color: #1f2937;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
            border: 2px solid #f1f5f9;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Alert row borders handled by Tailwind */

        .alert-row:last-child {
            border-bottom: none;
        }

        /* Alarm pulsing animation */
        @keyframes alarm-pulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7);
                transform: translate(-50%, -50%) scale(1);
            }

            50% {
                box-shadow: 0 0 0 15px rgba(220, 38, 38, 0);
                transform: translate(-50%, -50%) scale(1.1);
            }
        }

        .building-marker.has-alarm {
            animation: alarm-pulse 2s infinite;
        }

        .building-marker.has-alarm .status-badge {
            background-color: #dc2626 !important;
            animation: pulse 1s infinite;
        }

        @keyframes blink-red {
            0% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.5;
                transform: scale(1.1);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .blink-red {
            animation: blink-red 1s infinite ease-in-out;
        }

        /* Highlighted building animation */
        @keyframes highlight-pulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7);
                transform: translate(-50%, -50%) scale(1);
            }

            50% {
                box-shadow: 0 0 0 20px rgba(37, 99, 235, 0);
                transform: translate(-50%, -50%) scale(1.15);
            }
        }

        .building-marker.highlighted-building {
            animation: highlight-pulse 2s infinite;
            z-index: 50;
        }

        .building-marker.highlighted-building .status-badge {
            background-color: #2563eb !important;
        }

        /* Alerts Table Fixed Layout */
        .alerts-area table {
            table-layout: fixed;
            width: 100%;
        }

        .alerts-area th:nth-child(1),
        .alerts-area td:nth-child(1) {
            width: 15%;
        }

        /* Edificio */

        .alerts-area th:nth-child(2),
        .alerts-area td:nth-child(2) {
            width: 12%;
        }

        /* Planta */

        .alerts-area th:nth-child(3),
        .alerts-area td:nth-child(3) {
            width: 15%;
        }

        /* ID */

        .alerts-area th:nth-child(4),
        .alerts-area td:nth-child(4) {
            width: 10%;
        }

        /* Tipo */

        .alerts-area th:nth-child(5),
        .alerts-area td:nth-child(5) {
            width: 20%;
        }

        /* Ubicación */

        .alerts-area th:nth-child(6),
        .alerts-area td:nth-child(6) {
            width: 10%;
        }

        /* Hora */

        .alerts-area th:nth-child(7),
        .alerts-area td:nth-child(7) {
            width: 10%;
        }

        /* Origen */

        .alerts-area th:nth-child(8),
        .alerts-area td:nth-child(8) {
            width: 8%;
        }

        /* Estado */

        .alerts-area td {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Collapsible States */
        #main-layout {
            transition: grid-template-columns 0.3s ease, grid-template-rows 0.3s ease;
        }

        #main-layout.sidebar-collapsed {
            grid-template-columns: 1fr 0px !important;
        }

        #main-layout.alerts-collapsed {
            grid-template-rows: 1fr 0px !important;
        }

        .sidebar-area.collapsed {
            visibility: hidden;
            pointer-events: none;
            opacity: 0;
            transform: translateX(100%);
        }

        .alerts-area.collapsed {
            visibility: hidden;
            pointer-events: none;
            opacity: 0;
            transform: translateY(100%);
        }

        #sidebar-toggle-btn.active i {
            transform: rotate(180deg);
            color: #2563eb;
        }

        #alerts-toggle-btn.active {
            border-color: #ef4444;
            color: #ef4444;
        }

        #alerts-toggle-btn.active i#alerts-toggle-icon {
            transform: rotate(180deg);
        }
    </style>
</head>

<body class="h-full flex flex-col overflow-hidden bg-white dark:bg-gray-900 transition-colors duration-200">

    <!-- Header -->
    <header
        class="bg-white dark:bg-gray-800 dark:border-gray-700 py-3 md:py-4 px-4 md:px-8 border-b border-gray-200 shadow-sm relative z-30 flex-shrink-0">
        <div class="w-full flex flex-wrap justify-between items-center gap-2">
            <div class="flex items-center">
                <img alt="Unidad de Seguridad Universidad Zaragoza" class="h-[30px] md:h-[50px] w-auto transition-all"
                    src="logo_sec.png" />
            </div>

            <!-- Campus Info Center - Hidden on small mobile to save space -->
            <div id="campus-info-header"
                class="hidden sm:flex flex-1 flex-col items-center justify-center px-4 overflow-hidden">
                <h1 id="campus-title"
                    class="text-sm md:text-lg font-extrabold text-gray-900 dark:text-white leading-tight truncate w-full text-center">
                    Cargando...
                </h1>
                <p id="campus-desc" class="hidden"></p>
            </div>

            <div class="flex items-center gap-2 md:gap-4">
                <!-- Hidden elements for JS compatibility -->
                <div class="hidden">
                    <span id="current-user-role"></span>
                    <div id="admin-controls"></div>
                    <div id="alerts-panel"></div>
                    <span id="alert-badge"></span>
                </div>

                <a href="dashboard.html"
                    class="p-2 md:px-4 md:py-2 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-white text-gray-700 rounded-md text-xs md:text-sm font-medium transition-colors">
                    <i class="fa fa-arrow-left"></i> <span class="hidden md:inline">Volver</span>
                </a>

                <div class="flex items-center gap-2">
                    <button id="theme-toggle"
                        class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-gray-400"
                        title="Cambiar Tema">
                        <i class="fa-solid fa-moon dark:hidden text-lg"></i>
                        <i class="fa-solid fa-sun hidden dark:block text-lg text-yellow-400"></i>
                    </button>
                    <button onclick="logout()"
                        class="p-2 md:px-4 md:py-2 border border-gray-300 dark:border-gray-600 rounded-md text-xs md:text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                        <i class="fa fa-lock text-gray-400"></i> <span class="hidden md:inline">Salir</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Breadcrumbs -->
    <nav
        class="bg-gray-50 dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800 py-3 px-6 h-[48px] flex items-center shrink-0 transition-colors duration-200">
        <div class="flex items-center text-xs text-gray-500 dark:text-gray-400 gap-2">
            <a href="dashboard.html"
                class="hover:text-zaragoza-blue dark:hover:text-blue-400 transition-colors flex items-center gap-1.5">
                <i class="fa-solid fa-house"></i> Inicio
            </a>
            <i class="fa-solid fa-chevron-right text-[10px]"></i>
            <span id="campus-name-breadcrumb" class="font-semibold text-gray-800 dark:text-gray-200">Cargando
                Campus...</span>
        </div>
    </nav>

    <!-- Content Layout -->
    <div id="main-layout" class="layout-grid flex-grow transition-all duration-300 sidebar-collapsed alerts-collapsed">
        <!-- Campus Map Area -->
        <div class="map-area bg-gray-100 dark:bg-[#0f172a] overflow-hidden flex items-center justify-center relative">
            <!-- Decorative grid background -->
            <div class="absolute inset-0 opacity-10 pointer-events-none"
                style="background-image: radial-gradient(#94a3b8 1px, transparent 1px); background-size: 20px 20px;">
            </div>

            <div id="campus-map-container"
                class="w-full h-full relative bg-center bg-no-repeat bg-cover transition-transform shadow-[0_0_100px_rgba(0,0,0,0.5)] rounded-lg"
                style="transform-origin: 0 0;">
                <!-- Markers will be injected here -->
            </div>

            <!-- UI Toggles inside map -->
            <div class="absolute right-4 top-4 z-50 flex flex-col gap-3">
                <button onclick="toggleSidebar()" id="sidebar-toggle-btn"
                    class="bg-white/90 dark:bg-gray-800/90 w-12 h-12 rounded-full shadow-lg border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-white active:scale-95 transition-all flex items-center justify-center group active"
                    title="Alternar Panel de Edificios">
                    <i class="fa-solid fa-indent text-lg group-hover:text-blue-500"></i>
                </button>

                <!-- Zoom Controls (Mobile Friendly) -->
                <div
                    class="bg-white/90 dark:bg-gray-800/90 rounded-full shadow-lg border border-gray-200 dark:border-gray-700 flex flex-col overflow-hidden">
                    <button onclick="adjustZoom(1.1)"
                        class="w-12 h-12 flex items-center justify-center text-gray-700 dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 active:bg-gray-200 border-b border-gray-200 dark:border-gray-700">
                        <i class="fa-solid fa-plus text-lg"></i>
                    </button>
                    <button onclick="adjustZoom(0.9)"
                        class="w-12 h-12 flex items-center justify-center text-gray-700 dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 active:bg-gray-200">
                        <i class="fa-solid fa-minus text-lg"></i>
                    </button>
                </div>

                <button onclick="resetView()"
                    class="bg-white/90 dark:bg-gray-800/90 w-12 h-12 rounded-full shadow-lg border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-white active:scale-95 transition-all flex items-center justify-center group"
                    title="Resetear Vista">
                    <i class="fa-solid fa-compress text-lg group-hover:text-blue-500"></i>
                </button>
            </div>

            <div class="absolute bottom-4 left-1/2 -translate-x-1/2 z-50">
                <button onclick="toggleAlerts()" id="alerts-toggle-btn"
                    class="bg-white/90 dark:bg-gray-800/90 px-6 py-2 rounded-full shadow-lg border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-white hover:scale-105 transition-all flex items-center gap-2 group active"
                    title="Alternar Panel de Alertas">
                    <i class="fa-solid fa-list-check group-hover:text-red-500"></i>
                    <span class="text-xs font-bold uppercase">Alertas</span>
                    <i id="alerts-toggle-icon" class="fa-solid fa-chevron-down text-[10px] ml-1 opacity-50"></i>
                </button>
            </div>
        </div>

        <!-- Building Sidebar Area -->
        <div id="sidebar-panel"
            class="sidebar-area flex flex-col bg-[#f8fafc] dark:bg-gray-900 border-l dark:border-gray-800 transition-all duration-300 collapsed">
            <!-- Resizer Handle -->
            <div class="sidebar-resizer" id="sidebar-resizer" title="Arrastrar para redimensionar"></div>

            <div
                class="px-5 py-4 border-b dark:border-gray-800 bg-gray-50 dark:bg-gray-800 flex items-center justify-between sticky top-0 z-10">
                <span class="text-xs font-bold uppercase tracking-widest text-gray-500 dark:text-gray-400">Listado
                    de Edificios</span>
                <div class="flex items-center gap-2">
                    <span id="building-count"
                        class="bg-zaragoza-blue/10 dark:bg-blue-500/20 text-zaragoza-blue dark:text-blue-400 px-2 py-0.5 rounded text-[10px] font-bold">...</span>
                    <!-- Mobile Close Button -->
                    <button onclick="toggleSidebar()"
                        class="md:hidden text-gray-400 hover:text-gray-600 dark:hover:text-white p-1">
                        <i class="fa-solid fa-xmark text-lg"></i>
                    </button>
                </div>
            </div>
            <div id="building-list" class="flex-grow overflow-y-auto dark:bg-gray-900">
                <!-- Loading State -->
                <div class="p-8 text-center text-gray-400">
                    <i class="fa-solid fa-circle-notch fa-spin text-2xl mb-2"></i>
                    <p class="text-sm">Cargando edificios...</p>
                </div>
            </div>
        </div>

        <!-- System Alerts Panel Area -->
        <div id="alerts-panel-area"
            class="alerts-area flex flex-col bg-white dark:bg-gray-900 border-t border-gray-200 dark:border-gray-800 transition-all duration-300 collapsed">
            <div
                class="flex items-center justify-between px-6 py-3 bg-gray-50 dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800 sticky top-0 z-10">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                    <span class="text-xs font-bold uppercase tracking-widest text-gray-700 dark:text-gray-300">Alertas
                        del
                        Sistema</span>
                </div>
                <div class="flex items-center gap-4 text-xs">
                    <select id="filter-alerts"
                        class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 text-gray-700 dark:text-gray-300 rounded px-2 py-1 text-[11px] focus:ring-0">
                        <option value="all">Todas</option>
                        <option value="ALARM">Alarmas</option>
                        <option value="FAULT">Averías</option>
                    </select>
                    <button
                        class="bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 px-3 py-1 rounded transition-colors border border-gray-300 dark:border-gray-700">
                        Limpiar Resueltas
                    </button>
                    <button id="sim-incidence"
                        class="bg-red-600/20 hover:bg-red-600/30 text-red-400 px-3 py-1 rounded border border-red-500/30 transition-colors">
                        Simular Incidencia
                    </button>
                </div>
            </div>

            <div class="flex-grow overflow-auto">
                <table class="w-full text-left text-xs min-w-[1000px]">
                    <thead
                        class="bg-gray-100 dark:bg-gray-800/50 text-gray-600 dark:text-gray-400 font-semibold uppercase tracking-wider sticky top-0 z-10">
                        <tr>
                            <th class="px-6 py-3">Edificio</th>
                            <th class="px-6 py-3">Planta</th>
                            <th class="px-6 py-3">ID</th>
                            <th class="px-6 py-3">Tipo</th>
                            <th class="px-6 py-3">Ubicación</th>
                            <th class="px-6 py-3">Hora</th>
                            <th class="px-6 py-3">Origen</th>
                            <th class="px-6 py-3">Estado</th>
                        </tr>
                    </thead>
                    <tbody id="alerts-tbody" class="divide-y divide-gray-200 dark:divide-gray-800">
                        <!-- Alert rows injected here -->
                        <tr>
                            <td colspan="8" class="px-6 py-8 text-center text-gray-500 italic">No hay alertas
                                activas en
                                el campus</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import * as api from './js/api.js';
        import * as theme from './js/theme.js';

        window.logout = function () {
            api.logout();
            window.location.href = 'index.html';
        }

        const urlParams = new URLSearchParams(window.location.search);
        const campusId = urlParams.get('campusId');
        const highlightBuildingId = urlParams.get('buildingId'); // Get building ID from URL if present

        let buildings = [];
        let curCampus = null;

        // View State (Zoom/Pan)
        let scale = 0.8;
        let pointX = 0;
        let pointY = 0;
        let isPanning = false;
        let viewStartX, viewStartY;

        // Building Marker Drag State
        let isDragging = false;
        let isLongPress = false;
        let draggedBuildingId = null;
        let dragMarker = null;
        let dragTimeout = null;
        let startX, startY; // These are for building marker dragging

        async function init() {
            if (!campusId) {
                window.location.href = 'dashboard.html';
                return;
            }

            try {
                // Set User
                const user = api.getCurrentUser();
                if (!user) {
                    window.location.href = 'index.html';
                    return;
                }
                const isAdmin = user && user.role === 'admin';
                document.getElementById('current-user-role').textContent = user.username.toUpperCase();

                // Show admin controls if admin
                if (isAdmin) {
                    const adminControls = document.getElementById('admin-controls');
                    if (adminControls) {
                        adminControls.classList.remove('hidden');
                    }
                }

                // Show Save button if admin
                if (isAdmin) {
                    const headerInfo = document.getElementById('campus-info-header');
                    const saveBtn = document.createElement('button');
                    saveBtn.className = 'mt-1 bg-zaragoza-blue hover:bg-zaragoza-blue/90 text-white text-[9px] font-bold py-1 px-3 rounded-lg transition-all shadow-sm flex items-center justify-center gap-2';
                    saveBtn.innerHTML = '<i class="fa-solid fa-floppy-disk"></i> GUARDAR VISTA';
                    saveBtn.onclick = saveView;
                    headerInfo.appendChild(saveBtn);
                }

                // 1. Get Campus Info
                const campuses = await api.getCampuses();
                curCampus = campuses.find(c => c.id == campusId);

                if (curCampus) {
                    document.getElementById('campus-name-breadcrumb').textContent = curCampus.name;
                    document.getElementById('campus-title').textContent = curCampus.name;
                    document.getElementById('campus-desc').textContent = curCampus.description;

                    // Load saved view
                    scale = curCampus.scale || 0.8;
                    pointX = curCampus.offset_x || 0;
                    pointY = curCampus.offset_y || 0;

                    // Set initial background and transform
                    updateBackgroundImage();
                    updateTransform();
                }


                // 2. Load Buildings
                await refreshBuildings();

                // 3. Load Alerts Loop
                refreshAlerts();
                setInterval(refreshAlerts, 5000);

                // 4. Setup View Events
                setupViewControls();

                // 5. Global Toggle Functions
                window.toggleSidebar = function () {
                    const layout = document.getElementById('main-layout');
                    const panel = document.getElementById('sidebar-panel');
                    const btn = document.getElementById('sidebar-toggle-btn');

                    layout.classList.toggle('sidebar-collapsed');
                    panel.classList.toggle('collapsed');
                    btn.classList.toggle('active');

                    // Trigger resize to fix map positioning if needed
                    setTimeout(() => window.dispatchEvent(new Event('resize')), 300);
                };

                window.toggleAlerts = function () {
                    const layout = document.getElementById('main-layout');
                    const panel = document.getElementById('alerts-panel-area');
                    const btn = document.getElementById('alerts-toggle-btn');

                    layout.classList.toggle('alerts-collapsed');
                    panel.classList.toggle('collapsed');
                    btn.classList.toggle('active');

                    // Trigger resize
                    setTimeout(() => window.dispatchEvent(new Event('resize')), 300);
                };

            } catch (err) {
                console.error(err);
            }
        }

        function updateTransform() {
            const container = document.getElementById('campus-map-container');
            container.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
        }

        function updateBackgroundImage() {
            const container = document.getElementById('campus-map-container');
            if (curCampus) {
                const isDark = document.documentElement.classList.contains('dark');
                const darkBg = curCampus.background_image;
                const lightBg = curCampus.background_image_light;

                let bg = isDark ? darkBg : (lightBg || darkBg);
                if (!bg) bg = curCampus.image_filename;

                if (bg) {
                    const bgUrl = `url('${bg}')`;
                    if (container.style.backgroundImage !== bgUrl) {
                        container.style.backgroundImage = bgUrl;
                    }
                }
            }
        }

        function setupViewControls() {
            const mapArea = document.querySelector('.map-area');
            const container = document.getElementById('campus-map-container');

            mapArea.addEventListener('wheel', (e) => {
                e.preventDefault();
                const xs = (e.clientX - pointX) / scale;
                const ys = (e.clientY - pointY) / scale;
                const delta = -e.deltaY;
                (delta > 0) ? (scale *= 1.1) : (scale /= 1.1);
                if (scale < 0.1) scale = 0.1;
                if (scale > 5) scale = 5;
                pointX = e.clientX - xs * scale;
                pointY = e.clientY - ys * scale;
                updateTransform();
            }, { passive: false });

            mapArea.addEventListener('mousedown', (e) => {
                // Only pan if middle button or if alt is pressed or if dragging map and NOT a marker
                // But safer: if target is NOT a marker and NOT long pressing to drag marker
                if (e.target.closest('.building-marker')) return;

                isPanning = true;
                viewStartX = e.clientX - pointX;
                viewStartY = e.clientY - pointY;
                mapArea.style.cursor = 'grabbing';
            });

            let panningRAFBusy = false;
            window.addEventListener('mousemove', (e) => {
                if (!isPanning || panningRAFBusy) return;
                panningRAFBusy = true;
                requestAnimationFrame(() => {
                    if (!isPanning) {
                        panningRAFBusy = false;
                        return;
                    }
                    pointX = e.clientX - viewStartX;
                    pointY = e.clientY - viewStartY;
                    updateTransform();
                    panningRAFBusy = false;
                });
            });

            window.addEventListener('mouseup', () => {
                isPanning = false;
                mapArea.style.cursor = 'default';
            });
        }

        async function saveView() {
            try {
                await api.updateCampus(campusId, {
                    scale: parseFloat(scale.toFixed(4)),
                    offset_x: parseFloat(pointX.toFixed(2)),
                    offset_y: parseFloat(pointY.toFixed(2))
                });
                alert('Vista guardada correctamente');
            } catch (err) {
                console.error(err);
                alert('Error al guardar la vista');
            }
        }

        async function refreshBuildings() {
            try {
                buildings = await api.getBuildings(campusId);
                let events = [];
                try {
                    events = await api.getEvents({ resolved: 0, campusId: campusId, type: 'ALARM' });
                } catch (e) {
                    console.warn("Could not fetch events for status badges:", e.message);
                }

                document.getElementById('building-count').textContent = `${buildings.length} Edificios`;
                renderBuildings(buildings, events);
                renderMapMarkers(buildings, events);
            } catch (err) {
                console.error("Critical error in refreshBuildings:", err);
                document.getElementById('building-list').innerHTML = `<div class="p-8 text-center text-red-500 text-sm">Error cargando edificios</div>`;
            }
        }

        function renderBuildings(list, events) {
            const container = document.getElementById('building-list');
            container.innerHTML = '';

            if (list.length === 0) {
                container.innerHTML = '<div class="p-8 text-center text-gray-500 text-sm italic">No hay edificios registrados</div>';
                return;
            }

            list.forEach(b => {
                const hasAlarm = events.some(e => e.building_name === b.name || e.building_id === b.id);
                const card = document.createElement('div');
                card.className = "p-4 border-b dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors cursor-pointer group flex gap-4";
                card.onclick = () => window.location.href = `app.html?campusId=${campusId}&buildingId=${b.id}`;

                const statusText = hasAlarm ? 'Alerta Activa' : 'Normal';
                const statusColor = hasAlarm ? 'text-red-600' : 'text-green-600 dark:text-green-400';

                const thumbnailHtml = b.thumbnail
                    ? `<img src="/data/${b.thumbnail}" class="w-full h-full object-cover transition-transform group-hover:scale-110" />`
                    : `<div class="absolute inset-0 flex items-center justify-center text-gray-300 dark:text-gray-600">
                        <i class="fa-solid fa-building text-2xl ${hasAlarm ? 'text-red-200' : ''}"></i>
                       </div>`;

                card.innerHTML = `
                    <div class="h-20 w-28 bg-gray-100 dark:bg-gray-800 rounded-lg overflow-hidden flex-shrink-0 relative border border-gray-100 dark:border-gray-700">
                        ${thumbnailHtml}
                    </div>
                    <div class="flex-grow py-1">
                        <h4 class="font-bold text-gray-900 dark:text-gray-100 group-hover:text-zaragoza-blue dark:group-hover:text-blue-400 transition-colors">${b.name}</h4>
                        <p class="text-[11px] text-gray-500 dark:text-gray-400 mt-1 uppercase tracking-tight">Status: <span class="font-bold ${statusColor} uppercase">${statusText}</span></p>
                        <div class="mt-2 flex items-center gap-1.5 px-3 py-1 bg-gray-100 dark:bg-gray-800 group-hover:bg-zaragoza-blue group-hover:text-white dark:group-hover:bg-blue-600 rounded text-[11px] font-bold w-fit transition-colors dark:text-gray-300">
                            VIEW FLOOR PLANS <i class="fa-solid fa-chevron-right text-[9px]"></i>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }


        function renderMapMarkers(list, events) {
            const container = document.getElementById('campus-map-container');

            // If dragging, don't re-render markers to avoid breaking the drag session
            if (isDragging) return;

            const existingMarkers = container.querySelectorAll('.building-marker');
            existingMarkers.forEach(m => m.remove());

            const user = api.getCurrentUser();
            const isAdmin = user && user.role === 'admin';

            list.forEach((b, idx) => {
                const hasAlarm = events.some(e => e.building_name === b.name || e.building_id === b.id);
                const isHighlighted = highlightBuildingId && b.id == highlightBuildingId;

                const marker = document.createElement('div');
                // Priority: Alarm (red) > Highlighted (blue) > Normal (green)
                // If has alarm, always show alarm animation regardless of highlight
                marker.className = `building-marker group ${hasAlarm ? 'has-alarm' : (isHighlighted ? 'highlighted-building' : '')}`;
                marker.dataset.id = b.id;

                const left = b.x != null ? b.x : (20 + (idx * 15) % 65);
                const top = b.y != null ? b.y : (20 + (idx * 23) % 65);
                marker.style.left = `${left}%`;
                marker.style.top = `${top}%`;
                marker.style.transform = "translate(-50%, -50%)"; // Ensure base transform is set

                // Priority: Alarm (red) > Highlighted (blue) > Normal (green)
                const badgeColor = hasAlarm ? 'bg-red-600 animate-pulse' : (isHighlighted ? 'bg-blue-600 animate-pulse' : 'bg-green-500');
                const badgeIcon = hasAlarm ? 'fa-triangle-exclamation' : (isHighlighted ? 'fa-location-dot' : 'fa-check');

                marker.innerHTML = `
                    <div class="status-badge ${badgeColor} group-hover:scale-110 transition-transform">
                        <i class="fa-solid ${badgeIcon} text-white text-[10px]"></i>
                    </div>
                    <div class="marker-label flex items-center gap-2 pointer-events-none select-none">
                        <span>${b.name}</span>
                        <span class="px-1.5 py-0.5 bg-gray-100 rounded text-[9px] font-bold text-gray-400 group-hover:bg-zaragoza-blue group-hover:text-white transition-colors">Ver Planos</span>
                    </div>
                `;

                if (isAdmin) {
                    marker.onmousedown = (e) => {
                        if (e.button !== 0) return;

                        startX = e.clientX;
                        startY = e.clientY;
                        isLongPress = false;
                        marker.classList.add('is-pressing');

                        dragTimeout = setTimeout(() => {
                            isDragging = true;
                            isLongPress = true;
                            draggedBuildingId = b.id;
                            dragMarker = marker;
                            marker.classList.remove('is-pressing');
                            marker.classList.add('is-dragging');
                        }, 300); // 300ms feels more snappy
                    };
                }

                marker.onclick = (e) => {
                    if (isLongPress || isDragging) {
                        e.preventDefault();
                        e.stopPropagation();
                        return;
                    }
                    window.location.href = `app.html?campusId=${campusId}&buildingId=${b.id}`;
                };

                container.appendChild(marker);
            });

            // If a building is highlighted, scroll it into view in the sidebar
            if (highlightBuildingId) {
                setTimeout(() => {
                    const buildingCards = document.querySelectorAll('#building-list > div');
                    buildingCards.forEach(card => {
                        const cardBuildingId = card.onclick.toString().match(/buildingId=(\d+)/)?.[1];
                        if (cardBuildingId == highlightBuildingId) {
                            card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            // Add temporary highlight effect
                            card.classList.add('ring-2', 'ring-blue-500', 'bg-blue-50', 'dark:bg-blue-900/30');
                            setTimeout(() => {
                                card.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50', 'dark:bg-blue-900/30');
                            }, 3000);
                        }
                    });
                }, 500);
            }
        }

        document.addEventListener('mouseup', async (e) => {
            if (dragTimeout) {
                clearTimeout(dragTimeout);
                dragTimeout = null;
            }
            // Remove pressing state from any marker
            document.querySelectorAll('.building-marker.is-pressing').forEach(m => m.classList.remove('is-pressing'));

            if (!isDragging || !dragMarker) {
                // Not a drag, reset long press flag after a small delay
                setTimeout(() => { isLongPress = false; }, 100);
                return;
            }

            const x = parseFloat(dragMarker.style.left);
            const y = parseFloat(dragMarker.style.top);
            const bid = draggedBuildingId;

            dragMarker.classList.remove('is-dragging');

            const savedMarker = dragMarker;
            const savedBid = bid;

            setTimeout(() => {
                isDragging = false;
                isLongPress = false;
                draggedBuildingId = null;
                dragMarker = null;
            }, 100);

            try {
                const response = await api.updateBuilding(savedBid, { x, y });
                if (response.success) {
                    console.log(`Building ${savedBid} position auto-saved: ${x}, ${y}`);
                    const building = buildings.find(b => b.id == savedBid);
                    if (building) {
                        building.x = x;
                        building.y = y;
                    }
                }
            } catch (err) {
                console.error("Error saving position:", err);
            }
        });

        let rAFBusy = false;
        document.addEventListener('mousemove', (e) => {
            if (dragTimeout && !isDragging) {
                const dist = Math.sqrt(Math.pow(e.clientX - startX, 2) + Math.pow(e.clientY - startY, 2));
                if (dist > 10) {
                    clearTimeout(dragTimeout);
                    dragTimeout = null;
                }
            }

            if (!isDragging || !dragMarker || rAFBusy) return;

            rAFBusy = true;
            requestAnimationFrame(() => {
                if (!isDragging || !dragMarker) {
                    rAFBusy = false;
                    return;
                }

                const container = document.getElementById('campus-map-container');
                const rect = container.getBoundingClientRect();

                let x = ((e.clientX - rect.left) / rect.width) * 100;
                let y = ((e.clientY - rect.top) / rect.height) * 100;

                x = Math.max(0, Math.min(100, x));
                y = Math.max(0, Math.min(100, y));

                dragMarker.style.left = `${x.toFixed(2)}%`;
                dragMarker.style.top = `${y.toFixed(2)}%`;
                rAFBusy = false;
            });
        });

        async function refreshAlerts() {
            try {
                // Fetch ALL events and active alerts (Global)
                const [activeEvents, activeAlerts] = await Promise.all([
                    api.getEvents({ resolved: 0 }), // No campusId filter
                    api.getActiveAlerts()
                ]);

                // Merge: Use Map to avoid duplicates by elementId/device_id
                const mergedMap = new Map();

                // 1. Add Events (as base)
                activeEvents.forEach(e => {
                    const key = `event-${e.device_id}`;
                    mergedMap.set(key, {
                        ...e,
                        origin: e.origin || 'REAL'
                    });
                });

                // 2. Add Alerts (overriding or supplementing)
                activeAlerts.forEach(a => {
                    const key = `alert-${a.elementId}`;
                    mergedMap.set(key, {
                        building_id: a.buildingId || a.building_id,
                        building_name: a.buildingName || a.building_name,
                        floor_name: a.floor_name || 'Planta 1',
                        device_id: a.elementId,
                        device_type: a.type,
                        device_location: a.location,
                        timestamp: a.startedAt || a.started_at,
                        origin: a.origin,
                        campus_id: a.campus_id,
                        type: 'ALARM'
                    });
                });

                const allItems = Array.from(mergedMap.values()).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                const tbody = document.getElementById('alerts-tbody');

                if (allItems.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-8 text-center text-gray-500 italic text-[11px]">No hay alertas activas en el campus</td></tr>';
                } else {
                    tbody.innerHTML = allItems.map(e => {
                        const time = new Date(e.timestamp).toLocaleTimeString();
                        const isAlarm = e.type === 'ALARM';
                        const statusClass = isAlarm ? 'bg-red-500/10 text-red-500 border border-red-500/20' : 'bg-yellow-500/10 text-yellow-500 border border-yellow-500/20';

                        // Show different campus alarms with a badge or prefix if not the current one
                        const isOtherCampus = e.campus_id && e.campus_id != campusId;
                        const bName = e.building_name || 'Edificio ' + e.building_id;

                        return `
                        <tr class="alert-row hover:bg-gray-100 dark:hover:bg-gray-800/30 transition-colors cursor-pointer ${isOtherCampus ? 'opacity-80' : ''}" 
                            onclick="window.location.href='app.html?campusId=${e.campus_id || campusId}&buildingId=${e.building_id}'">
                            <td class="px-6 py-3 font-semibold text-gray-800 dark:text-gray-200">
                                ${isOtherCampus ? '<i class="fa-solid fa-earth-europe text-[10px] mr-1 text-blue-500" title="Alerta en otro Campus"></i>' : ''}
                                ${bName}
                            </td>
                            <td class="px-6 py-3 text-gray-600 dark:text-gray-400">${e.floor_name || 'N/A'}</td>
                            <td class="px-6 py-3 font-mono text-gray-500 dark:text-gray-500 uppercase">${e.device_id || 'SYS'}</td>
                            <td class="px-6 py-3 uppercase text-gray-600 dark:text-gray-400 font-medium">${e.device_type || 'N/A'}</td>
                            <td class="px-6 py-3 text-gray-600 dark:text-gray-400 truncate" title="${e.device_location}">${e.device_location || 'N/A'}</td>
                            <td class="px-6 py-3 text-gray-500 dark:text-gray-500 font-mono">${time}</td>
                            <td class="px-6 py-3 text-gray-600 dark:text-gray-400 tracking-wider">
                                <span class="px-1.5 py-0.5 rounded bg-gray-100 dark:bg-gray-800 text-[9px] font-bold">${e.origin || 'REAL'}</span>
                            </td>
                            <td class="px-6 py-3">
                                <span class="px-2 py-0.5 rounded-full text-[10px] font-bold uppercase ${statusClass}">
                                    ${e.type}
                                </span>
                            </td>
                        </tr>
                    `;
                    }).join('');
                }

                // Update markers and building list with combined status (ONLY for current campus)
                const currentCampusAlarms = allItems.filter(item => item.type === 'ALARM' && (!item.campus_id || item.campus_id == campusId));
                renderBuildings(buildings, currentCampusAlarms);
                renderMapMarkers(buildings, currentCampusAlarms);

                // Markers and lists are already updated above with combinedData
            } catch (err) { console.error("Error refreshing alerts:", err); }
        }

        // Simulation Button
        // Simulation Button
        document.getElementById('sim-incidence').onclick = () => {
            window.location.href = 'simulation.html';
        };


        init();

        // Theme Toggle Handler
        document.getElementById('theme-toggle').addEventListener('click', () => {
            theme.toggleTheme();
            // Brief delay to ensure class is applied before updating background
            setTimeout(updateBackgroundImage, 50);
        });

        // Monitor class changes on documentElement (for theme updates)
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'class') {
                    updateBackgroundImage();
                }
            });
        });
        observer.observe(document.documentElement, { attributes: true });

        // ========== SIDEBAR RESIZER ==========
        const resizer = document.getElementById('sidebar-resizer');
        let isResizing = false;
        let resizerStartX = 0;
        let resizerStartWidth = 0;

        // Load saved width from localStorage
        const savedWidth = localStorage.getItem('sidebar-width');
        if (savedWidth) {
            document.documentElement.style.setProperty('--sidebar-width', savedWidth + 'px');
        }

        resizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            resizerStartX = e.clientX;

            // Get current width
            const sidebarArea = document.querySelector('.sidebar-area');
            resizerStartWidth = sidebarArea.offsetWidth;

            resizer.classList.add('resizing');
            document.body.style.cursor = 'ew-resize';
            document.body.style.userSelect = 'none';

            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;

            // Calculate new width (moving left increases width, moving right decreases)
            const deltaX = resizerStartX - e.clientX;
            let newWidth = resizerStartWidth + deltaX;

            // Constrain width between 250px and 800px
            newWidth = Math.max(250, Math.min(800, newWidth));

            // Update CSS variable
            document.documentElement.style.setProperty('--sidebar-width', newWidth + 'px');
        });

        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                resizer.classList.remove('resizing');
                document.body.style.cursor = '';
                document.body.style.userSelect = '';

                // Save width to localStorage
                const currentWidth = getComputedStyle(document.documentElement)
                    .getPropertyValue('--sidebar-width')
                    .trim()
                    .replace('px', '');
                localStorage.setItem('sidebar-width', currentWidth);
            }
        });

        // Zoom Helpers
        window.adjustZoom = function (factor) {
            scale *= factor;
            if (scale < 0.1) scale = 0.1;
            if (scale > 5) scale = 5;
            updateTransform();
        };

        window.resetView = function () {
            scale = curCampus ? (curCampus.scale || 0.8) : 0.8;
            pointX = curCampus ? (curCampus.offset_x || 0) : 0;
            pointY = curCampus ? (curCampus.offset_y || 0) : 0;
            updateTransform();
        };
    </script>
</body>

</html>