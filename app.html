<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visor de Detectores de Incendio - Edificio CIRCE</title>
    <!-- Intentamos cargar, pero el inline de abajo asegura que funcione si esto falla -->
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/simulator.css">
    <link rel="stylesheet" href="/css/alerts.css">
    <link rel="stylesheet" href="/css/dark-mode.css">

    <style>
        /* Estilos de emergencia para asegurar modo oscuro si falla el CSS externo */
        :root {
            --bg-color: #1a1a1a;
            --panel-bg: #242424;
            --text-color: #e0e0e0;
            --accent-color: #2E6DA4;
            --detector-color: #ef4444;
            --pulsador-color: #3b82f6;
            --sirena-color: #f59e0b;
        }

        body.dark,
        html.dark {
            background-color: #0f172a !important;
            color: #f8fafc !important;
        }

        header {
            background: #1e293b !important;
            border-bottom: 1px solid #334155 !important;
            color: white !important;
            display: flex;
            align-items: center;
            padding: 0 20px;
            height: 70px;
        }

        .btn-primary {
            background: #3b82f6 !important;
            border: none !important;
            color: white !important;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
        }

        .btn-outline {
            background: #334155 !important;
            color: white !important;
            border: 1px solid #475569 !important;
            padding: 8px 16px;
            border-radius: 6px;
        }

        #simulator-panel {
            background: #1e293b !important;
            border-left: 1px solid #334155 !important;
            color: white !important;
        }

        .sim-item {
            border-bottom: 1px solid #334155 !important;
        }

        .sim-item:hover {
            background: #334155 !important;
        }

        #viewport {
            background-color: #020617 !important;
        }

        /* Elementos PCI (Hotspots) */
        .hotspot {
            position: absolute;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background-color: var(--detector-color);
            color: white;
            font-size: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            border: 2px solid white;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            transition: transform 0.2s;
        }

        .hotspot:hover {
            transform: translate(-50%, -50%) scale(1.3);
            z-index: 20;
        }

        .type-detector {
            background-color: #ef4444 !important;
        }

        .type-pulsador {
            background-color: #3b82f6 !important;
            border-radius: 4px !important;
        }

        .type-sirena {
            background-color: #f59e0b !important;
            border: 2px solid #000 !important;
        }

        .type-central {
            background-color: #8b5cf6 !important;
            border-radius: 2px !important;
        }

        .type-detector_ft {
            background-color: #f87171 !important;
            border: 2px dashed white !important;
        }

        /* Ajustes de Layout */
        #map-container {
            position: relative;
            display: inline-block;
        }

        #plano-img {
            max-width: 100%;
            display: block;
        }

        .header-logo img {
            height: 40px !important;
            width: auto;
        }

        header h1 {
            font-size: 1.25rem !important;
            margin: 0 15px !important;
            white-space: nowrap;
        }
    </style>

    <script>
        // Forzar modo oscuro siempre en Unizar para que se vea premium
        document.documentElement.classList.add('dark');
        localStorage.setItem('color-theme', 'dark');

        // Fix para filtros globales si fallan los modulos
        window.toggleFilter = function (type) {
            console.log("Toggle filter:", type);
            const btn = document.getElementById('filter-' + type);
            if (btn) btn.classList.toggle('btn-primary');
            if (btn) btn.classList.toggle('btn-outline');

            const dots = document.querySelectorAll('.type-' + type);
            dots.forEach(d => {
                const currentDisplay = window.getComputedStyle(d).display;
                d.style.setProperty('display', currentDisplay === 'none' ? 'flex' : 'none', 'important');
            });
        };
    </script>
</head>

<body>

    <header>
        <div class="header-logo">
            <img src="/logo_sec.png" alt="Universidad de Zaragoza" style="height: 50px;">
        </div>
        <div>
            <h1>Instalaci√≥n PCI - CIRCE</h1>
        </div>
        <div class="controls">
            <button id="theme-toggle" class="btn btn-outline" style="min-width: 40px; padding: 5px 10px;"
                title="Cambiar Tema">
                <i class="fa-solid fa-moon"></i>
            </button>
            <button id="btn-login" class="btn btn-outline" onclick="window.location.href='index.html'">üîë Login</button>
            <button id="btn-logout" class="btn btn-outline" onclick="performLogout()" style="display: none;">üîí
                Logout</button>
        </div>
        <div class="controls" id="admin-controls"
            style="display: none; border-left: 1px solid #ccc; padding-left: 10px; margin-left: 10px;">
            <select id="building-select" class="form-control">
                <option value="">Cargando edificios...</option>
            </select>
            <button class="btn btn-outline" onclick="openAddBuildingModal()" title="Nuevo Edificio">‚ûïüè¢</button>

            <select id="floor-select" class="form-control">
                <option>Selecciona Planta</option>
            </select>
            <button class="btn btn-outline" onclick="openAddFloorModal()" title="Nueva Planta">‚ûïüñºÔ∏è</button>
            <button class="btn btn-primary" onclick="openAddModal()">‚ûï Elemento</button>
            <button class="btn btn-outline" onclick="toggleEventsPanel()">üìã Eventos</button>
        </div>
        <div class="controls">
            <!-- Common controls -->
            <div
                style="display: flex; gap: 5px; margin-right: 15px; border-right: 1px solid #ddd; padding-right: 15px;">
                <button id="filter-detector" class="btn btn-primary" onclick="toggleFilter('detector')"
                    title="Ocultar/Mostrar Detectores" style="font-size: 0.8rem; padding: 4px 10px;">Detectores</button>
                <button id="filter-pulsador" class="btn btn-primary" onclick="toggleFilter('pulsador')"
                    title="Ocultar/Mostrar Pulsadores" style="font-size: 0.8rem; padding: 4px 10px;">Pulsadores</button>
                <button id="filter-sirena" class="btn btn-primary" onclick="toggleFilter('sirena')"
                    title="Ocultar/Mostrar Sirenas" style="font-size: 0.8rem; padding: 4px 10px;">Sirenas</button>
                <button id="filter-central" class="btn btn-primary" onclick="toggleFilter('central')"
                    title="Ocultar/Mostrar Centrales" style="font-size: 0.8rem; padding: 4px 10px;">Centrales</button>
            </div>

            <select id="building-select-public" class="form-control">
                <option value="">Cargando edificios...</option>
            </select>
            <select id="floor-select-public" class="form-control">
                <option>Selecciona Planta</option>
            </select>
            <button class="btn btn-outline" onclick="resetView()">üéØ Centrar</button>
        </div>
    </header>

    <div id="breadcrumbs"
        style="background: #f9f9f9; padding: 10px 20px; border-bottom: 1px solid #ddd; font-size: 0.9em; display: flex; align-items: center; gap: 8px;">
        <a href="dashboard.html" style="text-decoration: none; color: #2E6DA4;"><i class="fa fa-home"></i> Inicio</a>
        <span style="color: #999;">/</span>
        <a href="javascript:void(0)" id="bc-campus" style="text-decoration: none; color: #666;">Campus</a>
        <span style="color: #999;">/</span>
        <span id="bc-building" style="color: #333; font-weight: bold;">Edificio...</span>
        <!-- Optional Floor Breadcrumb if needed -->
    </div>

    <div class="toast" id="toast">‚úÖ Acci√≥n realizada</div>

    <div id="main-container" style="display: flex; flex: 1; overflow: hidden; position: relative;">
        <!-- VIEWPORT (MAPA) -->
        <div id="viewport"
            style="flex: 1; position: relative; overflow: hidden; background-color: #e5e5e5; display: flex; align-items: center; justify-content: center;">
            <div id="empty-state">
                <h3>Cargando sistema...</h3>
            </div>

            <div id="map-container">
                <img id="plano-img" src="" alt="Plano">
                <!-- Puntos renderizados din√°micamente -->
            </div>

            <div class="legend">
                <div class="legend-item" style="color:#666; font-style:italic; margin-bottom:10px;">
                    Mant√©n pulsado para mover
                </div>
                <div class="legend-item">
                    <div class="legend-dot circle" style="background:var(--detector-color)"></div>Detector
                </div>
                <div class="legend-item">
                    <div class="legend-dot square" style="background:var(--pulsador-color)"></div>Pulsador
                </div>
                <div class="legend-item">
                    <div class="legend-dot circle" style="background:var(--sirena-color); border:1px solid #333"></div>
                    Sirena
                </div>
                <div class="legend-item">
                    <div class="legend-dot square" style="background:var(--central-color)"></div>
                    Central
                </div>
            </div>
        </div>

        <!-- SIMULATOR PANEL (Refactored to Explorer) -->
        <!-- SIMULATOR PANEL (Refactored to Explorer) -->
        <div id="simulator-panel">
            <!-- Collapse/Expand Button -->
            <button class="panel-collapse-btn" id="panel-collapse-btn" onclick="toggleSimulatorPanel()"
                title="Minimizar/Expandir Panel">
                <i class="fa-solid fa-chevron-right"></i>
            </button>

            <!-- Wrapper for content to maintain width during animation -->
            <div class="sim-content-wrapper">
                <div class="sim-header">
                    <h3>Explorador & Simulador</h3>
                    <button id="sim-toggle-global" class="btn btn-outline"
                        style="width: 100%; justify-content: center; font-size: 0.8rem; margin-top: 5px;">Simulaci√≥n
                        OFF</button>
                </div>

                <div class="sim-controls">
                    <input type="text" id="sim-filter-input" placeholder="Buscar ID o Tipo..." class="form-control"
                        style="width: 100%; margin-bottom: 8px;">
                    <div style="display: flex; gap: 5px;">
                        <button id="sim-btn-all" class="btn btn-primary" style="flex: 1; font-size: 0.75rem;">Activar
                            Todo</button>
                        <button id="sim-btn-none" class="btn btn-outline"
                            style="flex: 1; font-size: 0.75rem;">Desactivar</button>
                    </div>
                </div>

                <div id="sim-list-container">
                    <!-- Items injected by JS -->
                </div>

                <div class="sim-footer">
                    Activos: <span id="sim-active-count">0 / 0</span>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- EVENTS HISTORY PANEL -->
    <div id="events-panel"
        style="position:absolute; right:320px; top:80px; width:300px; background:white; border:1px solid #ccc; box-shadow:-2px 0 10px rgba(0,0,0,0.1); display:none; flex-direction:column; max-height:calc(100% - 160px); z-index: 1000;">
        <div
            style="padding:10px; background:#f0f0f0; border-bottom:1px solid #ccc; display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0; font-size:1rem;">Historial de Eventos</h3>
            <button onclick="document.getElementById('events-panel').style.display='none'"
                style="background:none; border:none; cursor:pointer; font-size:1.2rem;">√ó</button>
        </div>
        <div class="events-list" id="events-list" style="overflow-y:auto; flex:1; padding:10px;">
            <div style="text-align:center; color:#999; padding:20px;">Cargando...</div>
        </div>
    </div>

    <!-- MODAL INFO (EDITABLE) -->
    <div class="modal-overlay" id="modal-info">
        <div class="modal">
            <div class="modal-header">
                <h3>Editar Equipo</h3>
                <button class="close-modal" onclick="closeModal('modal-info')">√ó</button>
            </div>
            <div class="modal-body" style="text-align: left;">

                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <div style="flex: 1;">
                        <label style="font-size: 0.8rem; color: #666;">N√∫mero</label>
                        <input type="text" id="edit-num" class="form-control"
                            style="width: 100%; box-sizing: border-box; font-size: 1.5rem; font-weight: bold; text-align: center;">
                    </div>
                    <div style="width: 120px;">
                        <label style="font-size: 0.8rem; color: #666;">Tipo</label>
                        <select id="edit-type" class="form-control" style="width: 100%; margin-top: 5px;">
                            <option value="detector">Detector</option>
                            <option value="detector">Detector Falso Techo (Deprecated - use detector_ft)</option>
                            <!-- Temporary fix until logic update -->
                            <option value="detector_ft">Detector Falso Techo</option>
                            <option value="pulsador">Pulsador</option>
                            <option value="sirena">Sirena</option>
                            <option value="central">Central de Incendios</option>
                        </select>
                    </div>
                </div>

                <div style="margin-bottom: 10px;">
                    <label style="font-size: 0.8rem; color: #666;">Ubicaci√≥n</label>
                    <input type="text" id="edit-loc" class="form-control" style="width: 100%; box-sizing: border-box;">
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="font-size: 0.8rem; color: #666;">ID Sistema</label>
                    <input type="text" id="edit-id" class="form-control"
                        style="width: 100%; box-sizing: border-box; font-family: monospace;">
                </div>

                <button id="btn-activate-siren" class="btn btn-primary"
                    style="display: none; width: 100%; margin-bottom: 10px;">üîî Activar Sirena F√≠sica</button>

                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="saveDeviceEdits()" style="flex: 1;">üíæ Guardar
                        Cambios</button>
                    <button id="btn-delete-device" class="btn btn-outline"
                        style="border-color: red; color: red;">üóëÔ∏è</button>
                </div>

            </div>
        </div>
    </div>

    <!-- MODAL ADD DEVICE -->
    <div class="modal-overlay" id="modal-add">
        <div class="modal">
            <div class="modal-header">
                <h3>A√±adir Dispositivo</h3>
                <button class="close-modal" onclick="closeModal('modal-add')">√ó</button>
            </div>
            <div class="modal-body" style="text-align: left;">
                <form id="add-form" onsubmit="saveNewDevice(event)">
                    <div style="margin-bottom: 10px;">
                        <label>Tipo:</label>
                        <select id="add-type" class="form-control" style="width: 100%; margin-top: 5px;">
                            <option value="detector">Detector</option>
                            <option value="detector_ft">Detector Falso Techo</option>
                            <option value="pulsador">Pulsador</option>
                            <option value="sirena">Sirena</option>
                            <option value="central">Central de Incendios</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label>N√∫mero / Etiqueta:</label>
                        <input type="text" id="add-number" class="form-control"
                            style="width: 100%; box-sizing: border-box; margin-top: 5px;" required>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label>Ubicaci√≥n:</label>
                        <input type="text" id="add-loc" class="form-control"
                            style="width: 100%; box-sizing: border-box; margin-top: 5px;" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%">Guardar</button>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL ADD BUILDING -->
    <div class="modal-overlay" id="modal-add-building">
        <div class="modal" style="max-width: 300px;">
            <div class="modal-header">
                <h3>A√±adir Nuevo Edificio</h3>
                <button class="close-modal" onclick="closeModal('modal-add-building')">√ó</button>
            </div>
            <div class="modal-body">
                <form onsubmit="saveNewBuilding(event)">
                    <div style="margin-bottom: 15px;">
                        <input type="text" id="add-building-name" class="form-control"
                            style="width: 100%; box-sizing: border-box;" required placeholder="Nombre del Edificio">
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%">Crear Edificio</button>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL ADD FLOOR -->
    <div class="modal-overlay" id="modal-add-floor">
        <div class="modal">
            <div class="modal-header">
                <h3>A√±adir Nueva Planta</h3>
                <button class="close-modal" onclick="closeModal('modal-add-floor')">√ó</button>
            </div>
            <div class="modal-body" style="text-align: left;">
                <form id="add-floor-form" onsubmit="saveNewFloor(event)">
                    <div style="margin-bottom: 15px;">
                        <label>Nombre de la Planta:</label>
                        <input type="text" id="add-floor-name" class="form-control"
                            style="width: 100%; box-sizing: border-box; margin-top: 5px;" required
                            placeholder="Ej. Planta 2">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label>Imagen del Plano:</label>
                        <input type="file" id="add-floor-file" class="form-control"
                            style="width: 100%; box-sizing: border-box; margin-top: 5px;" accept="image/*" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%">Subir y Crear</button>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL LOGIN REMOVED - NOW USES index.html -->


    <div class="footer-bar">
        Desarrollado por Luis Enrique Seco <span style="font-weight: bold;">UNIDAD DE SEGURIDAD</span>
    </div>

    <!-- ALERTS PANEL -->
    <div id="alerts-panel">
        <div class="alerts-header">
            <h3>Alertas del Sistema</h3>
            <div class="alerts-actions">
                <select id="alert-filter-select" onchange="alerts.setFilter(this.value)"
                    style="margin-right: 5px; padding: 2px;">
                    <option value="ALL">Todas</option>
                    <option value="ACTIVA">Activas</option>
                    <option value="RESUELTA">Resueltas</option>
                </select>
                <button id="btn-refresh-alerts" onclick="alerts.refreshSummary()"
                    title="Sincronizar con Simulador">üîÑ</button>
                <button id="btn-clear-resolved" onclick="alerts.clearResolved()">Limpiar Resueltas</button>
                <button id="btn-toggle-panel"
                    onclick="document.getElementById('alerts-panel').classList.toggle('minimized')">_</button>
            </div>
        </div>
        <div class="alerts-content">
            <table>
                <thead>
                    <tr>
                        <th>Edificio</th>
                        <th>Planta</th>
                        <th>ID</th>
                        <th>Tipo</th>
                        <th>Ubicaci√≥n</th>
                        <th>Hora</th>
                        <th>Origen</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody id="alerts-table-body">
                    <!-- Rows injected by alerts.js -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script type="module" src="js/simulator.js"></script>
    <script type="module" src="js/alerts.js"></script>
    <!-- Socket.io -->
    <script src="/socket.io/socket.io.js"></script>
    <script type="module" src="js/realtime.js"></script>
    <script type="module" src="js/app.js"></script>
    <script type="module">
        import * as theme from './js/theme.js';

        // Theme Toggle Handler
        document.getElementById('theme-toggle').addEventListener('click', () => {
            theme.toggleTheme();
            updateAppCheck();
        });

        function updateAppCheck() {
            const isDark = theme.isDark();
            const icon = document.querySelector('#theme-toggle i');
            if (isDark) {
                icon.className = 'fa-solid fa-sun';
                icon.style.color = '#fbbf24'; // yellow
            } else {
                icon.className = 'fa-solid fa-moon';
                icon.style.color = '';
            }
        }

        // Init icon
        updateAppCheck();

        // ========== SIMULATOR PANEL TOGGLE ==========
        window.toggleSimulatorPanel = function () {
            const panel = document.getElementById('simulator-panel');
            const isCollapsed = panel.classList.toggle('collapsed');

            // Save state to localStorage
            localStorage.setItem('simulator-panel-collapsed', isCollapsed);
        };

        // Load saved panel state
        const savedPanelState = localStorage.getItem('simulator-panel-collapsed');
        if (savedPanelState === 'true') {
            document.getElementById('simulator-panel').classList.add('collapsed');
        }
    </script>
</body>

</html>