<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Visor PCI</title>
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { 'zaragoza-blue': '#2E6DA4' }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <style>
        .active-tab {
            border-bottom: 2px solid #2563EB;
            color: #2563EB;
        }

        /* Override Chrome/Edge Autofill background */
        .dark input:-webkit-autofill,
        .dark input:-webkit-autofill:hover,
        .dark input:-webkit-autofill:focus,
        .dark input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 30px #374151 inset !important;
            -webkit-text-fill-color: white !important;
            transition: background-color 5000s ease-in-out 0s;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800 font-sans dark:bg-gray-900 dark:text-gray-100">
    <header
        class="bg-white shadow px-8 py-4 flex justify-between items-center dark:bg-gray-800 dark:border-b dark:border-gray-700">
        <div class="flex items-center gap-4">
            <img src="logo_sec.png" class="h-[40px] w-auto transition-all" alt="Logo">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <i class="fa fa-cogs text-blue-600"></i> Administración del Sistema
            </h1>
        </div>
        <div class="flex gap-4">
            <a href="dashboard.html" class="text-gray-600 hover:text-blue-600 font-medium">Volver al Dashboard</a>

            <!-- Dark Mode Toggle -->
            <button id="theme-toggle"
                class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors focus:outline-none"
                title="Cambiar Tema">
                <i class="fa-solid fa-moon text-gray-600 dark:hidden text-lg"></i>
                <i class="fa-solid fa-sun text-yellow-400 hidden dark:block text-lg"></i>
            </button>

            <button onclick="logout()" class="text-red-500 hover:text-red-700 font-medium">Logout</button>
        </div>
    </header>

    <main class="max-w-full mx-auto mt-8 p-4">
        <!-- Tabs -->
        <div class="flex border-b border-gray-200 mb-6">
            <button id="tab-users" class="px-6 py-2 font-medium text-gray-500 hover:text-blue-600 active-tab"
                onclick="switchTab('users')">Usuarios</button>
            <button id="tab-gateways" class="px-6 py-2 font-medium text-gray-500 hover:text-blue-600"
                onclick="switchTab('gateways')">Pasarelas y Hardware</button>
            <button id="tab-plans" class="px-6 py-2 font-medium text-gray-500 hover:text-blue-600"
                onclick="switchTab('plans')">Cargar planos edificios</button>
            <button id="tab-notifications" class="px-6 py-2 font-medium text-gray-500 hover:text-blue-600"
                onclick="switchTab('notifications')">Notificaciones</button>
        </div>

        <!-- Users Section -->
        <div id="section-users" class="block">
            <!-- (Existing Users Content remains...) -->
            <div class="flex justify-between mb-4">
                <h2 class="text-lg font-semibold dark:text-white">Gestión de Usuarios</h2>
                <button onclick="document.getElementById('modal-user').classList.remove('hidden')"
                    class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                    + Nuevo Usuario
                </button>
            </div>
            <!-- ... table content ... (will update styling separately or rely on tailwind defaults for now, focusing on structure first) -->
            <!-- Actually, let's keep the user block minimal here as I can't replace the whole block efficiently without big context. 
                 Wait, I should only target the tabs and then ADD the new section. 
                 Let's split this into modifying tabs and then appending the new section. -->

            <div class="bg-white dark:bg-gray-800 rounded shadow overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                Usuario</th>
                            <th
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                Rol</th>
                            <th
                                class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="users-table"
                        class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                        <!-- JS Injected -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Gateways Section -->
        <div id="section-gateways" class="hidden">
            <!-- Simulator Control Card -->
            <div
                class="bg-blue-50 dark:bg-blue-900/20 border-l-4 border-blue-400 p-4 mb-6 rounded shadow-sm flex items-center justify-between transition-colors">
                <div>
                    <h3 class="text-blue-800 dark:text-blue-300 font-bold flex items-center gap-2">
                        <i class="fa fa-terminal"></i> Simulador Local Modbus
                    </h3>
                    <p class="text-xs text-blue-600 dark:text-blue-400">Simula una central de incendios para pruebas sin
                        hardware real.</p>
                </div>
                <div class="flex items-center gap-4">
                    <div id="sim-status-badge"
                        class="px-2 py-1 rounded text-xs font-bold bg-gray-200 text-gray-500 dark:bg-gray-700 dark:text-gray-300">
                        OFFLINE
                    </div>
                    <div class="flex gap-2">
                        <button id="btn-start-sim" onclick="handleStartSim()"
                            class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 transition-colors dark:bg-blue-700 dark:hover:bg-blue-600">Habilitar</button>
                        <button id="btn-stop-sim" onclick="handleStopSim()"
                            class="bg-white dark:bg-gray-700 border dark:border-gray-600 text-red-500 dark:text-red-400 px-3 py-1 rounded text-sm hover:bg-red-50 dark:hover:bg-red-900/30 transition-colors">Paro
                            Forzado</button>
                    </div>
                </div>
            </div>

            <div class="flex justify-between mb-4">
                <h2 class="text-lg font-semibold">Configuración de Pasarelas (Modbus/BACnet)</h2>
                <button onclick="document.getElementById('modal-gateway').classList.remove('hidden')"
                    class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                    + Nueva Pasarela
                </button>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded shadow overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                Nombre</th>
                            <th
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                Tipo</th>
                            <th
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                IP / Puerto</th>
                            <th
                                class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="gateways-table"
                        class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                        <!-- JS Injected -->
                    </tbody>
                </table>
            </div>

            <!-- New Section: Buildings Modbus Config -->
            <div class="mt-8 mb-4">
                <h2 class="text-lg font-semibold">Configuración de Centrales por Edificio</h2>
                <p class="text-sm text-gray-500 mb-2">Asigna la IP de la central (SOLAE) correspondiente a cada
                    edificio.</p>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded shadow overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                Edificio</th>
                            <th
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                Tipo</th>
                            <th
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                IP / Puerto</th>
                            <th
                                class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="buildings-modbus-table"
                        class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                        <!-- JS Injected -->
                    </tbody>
                </table>
            </div>
        </div>
        <!-- Plans Section -->
        <div id="section-plans" class="hidden">
            <h2 class="text-lg font-semibold mb-4">Gestión de Planos de Edificios</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- List -->
                <div class="bg-white dark:bg-gray-800 rounded shadow p-4 transition-colors">
                    <h3 class="font-bold text-gray-700 dark:text-gray-200 mb-2">Seleccionar Edificio</h3>
                    <ul id="buildings-list" class="space-y-2">
                        <!-- JS Injected -->
                        <li class="text-sm text-gray-500 dark:text-gray-400 italic">Cargando...</li>
                    </ul>
                </div>

                <!-- Detail / Drop Zone -->
                <div class="bg-white dark:bg-gray-800 rounded shadow p-4 md:col-span-2 transition-colors">
                    <div id="plan-detail-placeholder" class="text-center py-12 text-gray-400 dark:text-gray-500">
                        <i class="fa fa-building text-4xl mb-2"></i>
                        <p>Selecciona un edificio para gestionar sus planos</p>
                    </div>

                    <div id="plan-detail-content" class="hidden space-y-4">
                        <div class="flex justify-between items-center border-b dark:border-gray-700 pb-2">
                            <h3 id="selected-building-name" class="font-bold text-xl text-blue-800 dark:text-blue-300">
                                Nombre Edificio</h3>
                            <span
                                class="text-xs bg-blue-100/50 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300 px-2 py-1 rounded">ID:
                                <span id="selected-building-id"></span></span>
                        </div>

                        <!-- Drop Zone -->
                        <div class="mb-4">
                            <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Nombre de la
                                Planta
                                (Opcional)</label>
                            <input type="text" id="new-floor-name"
                                class="w-full border dark:border-gray-600 rounded p-2 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 transition-colors"
                                placeholder="Ej: Planta 1 (Si se deja vacío se usará el nombre del archivo)">
                        </div>

                        <input type="file" id="file-input" class="hidden" accept="image/*">
                        <div id="drop-zone"
                            class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-8 text-center hover:bg-blue-50 dark:hover:bg-gray-700 transition-colors cursor-pointer relative dark:bg-gray-800">
                            <i class="fa fa-cloud-upload-alt text-4xl text-blue-400 mb-2"></i>
                            <p class="font-medium text-gray-600 dark:text-gray-300">Arrastra aquí el plano de la nueva
                                planta</p>
                            <p class="text-xs text-gray-400 mt-1">o haz click para seleccionar (JPG, PNG)</p>
                        </div>

                        <!-- Floors List (Preview) -->
                        <div class="mt-4">
                            <h4 class="font-semibold text-gray-700 text-sm mb-2">Plantas existentes:</h4>
                            <ul id="floors-list" class="grid grid-cols-2 gap-4">
                                <!-- JS Injected -->
                            </ul>
                            <!-- Config Container -->
                            <div id="building-config-container"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notifications Section -->
        <div id="section-notifications" class="hidden">
            <h2 class="text-lg font-semibold mb-4">Gestión de Notificaciones</h2>
            <div class="bg-white dark:bg-gray-800 rounded shadow p-4 transition-colors" style="min-height: 600px;">
                <iframe src="notifications.html" class="w-full border-0 rounded" style="height: 700px;"
                    title="Panel de Notificaciones">
                </iframe>
            </div>
        </div>


    </main>

    <!-- (Modals remain...) -->
    <!-- Modal Create User -->
    <div id="modal-user" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded shadow-lg w-96">
            <h3 class="text-lg font-bold mb-4 dark:text-white">Crear Usuario</h3>
            <form onsubmit="handleCreateUser(event)">
                <div class="mb-4">
                    <label class="block text-sm font-bold mb-1 dark:text-gray-200">Username</label>
                    <input type="text" id="new-user-name"
                        class="w-full border dark:border-gray-600 rounded p-2 dark:bg-gray-700 dark:text-white"
                        required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-bold mb-1 dark:text-gray-200">Password</label>
                    <input type="password" id="new-user-pass"
                        class="w-full border dark:border-gray-600 rounded p-2 dark:bg-gray-700 dark:text-white"
                        required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-bold mb-1 dark:text-gray-200">Rol</label>
                    <select id="new-user-role"
                        class="w-full border dark:border-gray-600 rounded p-2 dark:bg-gray-700 dark:text-white">
                        <option value="viewer">Viewer</option>
                        <option value="operator">Operator</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="document.getElementById('modal-user').classList.add('hidden')"
                        class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Crear</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Create Gateway -->
    <div id="modal-gateway" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded shadow-lg w-96">
            <h3 class="text-lg font-bold mb-4 dark:text-white">Nueva Pasarela</h3>
            <form onsubmit="handleCreateGateway(event)">
                <div class="mb-4">
                    <label class="block text-sm font-bold mb-1 dark:text-gray-200">Nombre</label>
                    <input type="text" id="gw-name"
                        class="w-full border dark:border-gray-600 rounded p-2 dark:bg-gray-700 dark:text-white"
                        required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-bold mb-1 dark:text-gray-200">Tipo</label>
                    <select id="gw-type"
                        class="w-full border dark:border-gray-600 rounded p-2 dark:bg-gray-700 dark:text-white">
                        <option value="MODBUS">MODBUS TCP</option>
                        <option value="BACNET">BACNET IP</option>
                    </select>
                </div>
                <div class="flex gap-2">
                    <div class="mb-4 flex-1">
                        <label class="block text-sm font-bold mb-1 dark:text-gray-200">IP</label>
                        <input type="text" id="gw-ip"
                            class="w-full border dark:border-gray-600 rounded p-2 dark:bg-gray-700 dark:text-white"
                            placeholder="192.168.1.10">
                    </div>
                    <div class="mb-4 w-24">
                        <label class="block text-sm font-bold mb-1 dark:text-gray-200">Puerto</label>
                        <input type="number" id="gw-port"
                            class="w-full border dark:border-gray-600 rounded p-2 dark:bg-gray-700 dark:text-white"
                            placeholder="502">
                    </div>
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="document.getElementById('modal-gateway').classList.add('hidden')"
                        class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">Cancelar</button>
                    <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded">Guardar</button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        import * as api from './js/api.js';
        import * as theme from './js/theme.js';

        // Check Auth & Role
        const user = api.getCurrentUser();
        if (!user || user.role !== 'admin') {
            alert('Acceso Denegado. Se requiere rol de Administrador.');
            window.location.href = 'index.html';
        }

        // Toggle Logic with simple header button
        document.getElementById('theme-toggle').addEventListener('click', () => {
            theme.toggleTheme();
        });

        window.logout = function () {
            api.logout();
            window.location.href = 'index.html';
        };

        window.switchTab = function (tab) {
            document.querySelectorAll('button[id^="tab-"]').forEach(b => b.classList.remove('active-tab'));
            document.getElementById(`tab-${tab}`).classList.add('active-tab');

            document.getElementById('section-users').classList.add('hidden');
            document.getElementById('section-gateways').classList.add('hidden');
            document.getElementById('section-plans').classList.add('hidden');
            document.getElementById('section-notifications').classList.add('hidden');
            // config removed
            document.getElementById(`section-${tab}`).classList.remove('hidden');

            if (tab === 'users') loadUsers();
            if (tab === 'gateways') { loadGateways(); loadBuildingGateways(); refreshSimStatus(); }
            if (tab === 'plans') loadBuildingsForPlans();
            // notifications loads via iframe, no init needed
            // config needs no load
        };

        // --- USERS ---
        async function loadUsers() {
            try {
                const users = await api.getUsers();
                const tbody = document.getElementById('users-table');
                tbody.innerHTML = users.map(u => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${u.username}</td>
                        <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">${u.role}</span></td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="deleteUser(${u.id})" class="text-red-600 hover:text-red-900 ml-4">Borrar</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) { console.error(e); }
        }

        window.handleCreateUser = async function (e) {
            e.preventDefault();
            try {
                const name = document.getElementById('new-user-name').value;
                const pass = document.getElementById('new-user-pass').value;
                const role = document.getElementById('new-user-role').value;
                await api.createUser(name, pass, role);
                document.getElementById('modal-user').classList.add('hidden');
                loadUsers();
            } catch (e) { alert('Error creando usuario'); }
        };

        window.deleteUser = async function (id) {
            if (!confirm('¿Seguro que quieres borrar este usuario?')) return;
            try {
                await api.deleteUser(id);
                loadUsers();
            } catch (e) { alert('Error borrando usuario'); }
        }

        // --- GATEWAYS ---
        async function loadGateways() {
            try {
                const gws = await api.getGateways();
                const tbody = document.getElementById('gateways-table');
                tbody.innerHTML = gws.map(g => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap font-bold">${g.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-gray-500">${g.type}</td>
                        <td class="px-6 py-4 whitespace-nowrap font-mono text-sm">${g.ip_address}:${g.port}</td>
                         <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button class="text-gray-400 cursor-not-allowed">Editar</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) { console.error(e); }
        }

        window.handleCreateGateway = async function (e) {
            e.preventDefault();
            try {
                const gw = {
                    name: document.getElementById('gw-name').value,
                    type: document.getElementById('gw-type').value,
                    ip_address: document.getElementById('gw-ip').value,
                    port: document.getElementById('gw-port').value
                };
                await api.createGateway(gw);
                document.getElementById('modal-gateway').classList.add('hidden');
                loadGateways();
            } catch (e) { alert('Error creando pasarela'); }
        }

        // --- SIMULATOR ---
        async function refreshSimStatus() {
            try {
                const status = await api.getSimulatorStatus();
                const badge = document.getElementById('sim-status-badge');
                const btnStart = document.getElementById('btn-start-sim');
                const btnStop = document.getElementById('btn-stop-sim');

                if (status.running) {
                    badge.innerText = 'SIMULADOR ACTIVO';
                    badge.className = 'px-2 py-1 rounded text-xs font-bold bg-green-100 text-green-700 animate-pulse';
                    btnStart.disabled = true;
                    btnStart.classList.add('opacity-50', 'cursor-not-allowed');
                    btnStop.classList.replace('bg-blue-600', 'bg-white'); // Ensure stop button isn't blue while running
                    btnStop.classList.remove('text-white');
                    btnStop.classList.add('text-red-500');
                } else {
                    // Blue indicates Hardware/Clean mode
                    badge.innerText = 'MODO HARDWARE';
                    badge.className = 'px-2 py-1 rounded text-xs font-bold bg-blue-100 text-blue-700';
                    btnStart.disabled = false;
                    btnStart.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            } catch (e) {
                console.error('Error refreshing sim status:', e);
            }
        }

        window.handleStartSim = async function () {
            const btn = document.getElementById('btn-start-sim');
            btn.innerText = 'Iniciando...';
            try {
                await api.startSimulator();
                setTimeout(refreshSimStatus, 2000);
            } catch (e) { alert('Error iniciando simulador'); }
            finally { btn.innerText = 'Habilitar'; }
        };

        window.handleStopSim = async function () {
            const btn = document.getElementById('btn-stop-sim');
            const originalText = btn.innerText;
            btn.innerText = 'Forzando Paro...';
            btn.classList.add('bg-blue-600', 'text-white'); // Turn blue during action as requested
            btn.classList.remove('text-red-500');

            try {
                await api.stopSimulator();
                // Keep it blue for a moment if successful
                btn.innerText = '¡Paro Realizado!';
                setTimeout(() => {
                    btn.innerText = originalText;
                    btn.classList.remove('bg-blue-600', 'text-white');
                    btn.classList.add('text-red-500');
                    refreshSimStatus();
                }, 2000);
            } catch (e) {
                alert('Error deteniendo simulador');
                btn.innerText = originalText;
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('text-red-500');
            }
        };

        // --- BUILDING MODBUS CONFIG ---
        async function loadBuildingGateways() {
            try {
                const buildings = await api.getBuildings();
                const tbody = document.getElementById('buildings-modbus-table');

                tbody.innerHTML = buildings.map(b => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap font-medium dark:text-gray-200">${b.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-gray-500">SOLAE / Modbus</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex gap-2">
                                <input type="text" id="bm-ip-${b.id}" value="${b.modbus_ip || ''}" class="border rounded p-1 text-sm w-32 dark:bg-gray-700 dark:text-white" placeholder="IP">
                                <input type="number" id="bm-port-${b.id}" value="${b.modbus_port || 502}" class="border rounded p-1 text-sm w-20 dark:bg-gray-700 dark:text-white" placeholder="502">
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm">
                            <button onclick="saveBuildingModbus(${b.id})" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 transition-colors">Guardar</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) { console.error('Error loading building modbus:', e); }
        }

        window.saveBuildingModbus = async function (id) {
            const ip = document.getElementById(`bm-ip-${id}`).value;
            const port = document.getElementById(`bm-port-${id}`).value;
            const btn = event.target;
            const originalText = btn.innerText;

            btn.innerText = '...';

            try {
                const res = await fetch(`/api/buildings/${id}/modbus`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    },
                    body: JSON.stringify({ ip, port })
                });

                if (res.ok) {
                    btn.innerText = '¡Guardado!';
                    btn.classList.replace('bg-blue-600', 'bg-green-600');
                    setTimeout(() => {
                        btn.innerText = originalText;
                        btn.classList.replace('bg-green-600', 'bg-blue-600');
                    }, 2000);
                } else {
                    alert('Error guardando configuración');
                    btn.innerText = originalText;
                }
            } catch (e) {
                console.error(e);
                alert('Error de conexión');
                btn.innerText = originalText;
            }
        };

        // --- PLANS ---
        let currentBuildingId = null;
        let currentBuildingFloors = [];

        async function loadBuildingsForPlans() {
            try {
                const buildings = await api.getBuildings();
                const list = document.getElementById('buildings-list');
                list.innerHTML = buildings.map(b => `
                    <li onclick="selectBuilding(${b.id}, '${b.name}')" 
                        class="p-2 hover:bg-blue-50 dark:hover:bg-gray-700 rounded cursor-pointer flex justify-between items-center group transition-colors ${currentBuildingId === b.id ? 'bg-blue-100 dark:bg-blue-900/50 ring-1 ring-blue-300 dark:ring-blue-700' : 'bg-gray-50 dark:bg-gray-700/50'}">
                        <span class="font-medium group-hover:text-blue-700 dark:text-gray-200 dark:group-hover:text-blue-400">${b.name}</span>
                        <i class="fa fa-chevron-right text-xs text-gray-300 group-hover:text-blue-500"></i>
                    </li>
                `).join('');

            } catch (e) {
                console.error(e);
            }
        }

        window.selectBuilding = async function (id, name) {
            currentBuildingId = id;
            document.getElementById('plan-detail-placeholder').classList.add('hidden');
            document.getElementById('plan-detail-content').classList.remove('hidden');
            document.getElementById('selected-building-name').innerText = name;
            document.getElementById('selected-building-id').innerText = id;

            // Highlight list item
            loadBuildingsForPlans(); // Re-render to update highlight (lazy way)
            loadFloorsForBuilding(id);
        }

        async function loadFloorsForBuilding(id) {
            try {
                currentBuildingFloors = await api.getFloors(id); // Store globally
                const list = document.getElementById('floors-list');
                list.innerHTML = currentBuildingFloors.map(f => {
                    // Determine path based on legacy vs new structure
                    const isNewStructure = f.image_filename.includes('/') || f.image_filename.includes('\\');
                    // Legacy files are in root, new files in datos_edificios (mapped to /data)
                    const src = isNewStructure ? `/data/${f.image_filename}` : `/${f.image_filename}`;

                    return `
                    <li class="bg-gray-50 border rounded p-2 flex items-center gap-3 justify-between group">
                        <div class="flex items-center gap-3 overflow-hidden">
                            <div class="w-10 h-10 bg-gray-200 rounded overflow-hidden flex-shrink-0 border border-gray-300">
                                <img src="${src}" class="w-full h-full object-cover">
                            </div>
                            <div class="overflow-hidden">
                                <p class="font-bold text-sm truncate">${f.name}</p>
                                <p class="text-xs text-gray-500 truncate" title="${f.image_filename}">${f.image_filename}</p>
                            </div>
                        </div>
                        <button onclick="handleDeleteFloor(${f.id}, event)" class="text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity p-2" title="Eliminar Plano">
                            <i class="fa fa-trash"></i>
                        </button>
                    </li>
                `}).join('');

                // [NEW] Elementos Existentes UI - CSV Upload + [NEW] TABLE
                const configContainer = document.getElementById('building-config-container');
                if (configContainer) {
                    configContainer.innerHTML = `
                        <div class="mt-6 pt-6 border-t border-gray-200">
                            <h4 class="text-sm font-bold text-gray-700 mb-2">Elementos existentes:</h4>
                            <p class="text-xs text-gray-500 mb-4">Carga masiva de dispositivos (CSV) para este edificio. Sobrescribirá los datos actuales.</p>
                            
                            <div id="drop-zone-config" 
                                 class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-all bg-white"
                                 onclick="document.getElementById('file-input-config').click()">
                                <i class="fa fa-file-csv text-3xl text-gray-300 mb-2"></i>
                                <p class="text-sm text-gray-500 font-medium">Arrastra aquí el archivo dispositivos_edificio.csv</p>
                                <p class="text-[10px] text-gray-400">o haz click para seleccionar</p>
                                <input type="file" id="file-input-config" class="hidden" accept=".csv" onchange="handleConfigUpload(this)">
                            </div>
                        </div>

                        <!-- [NEW] Device Table -->
                        <div class="mt-8">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="text-sm font-bold text-gray-700">Tabla de Dispositivos</h4>
                                <div class="flex gap-2">
                                    <button onclick="exportDevicesToCSV()" class="bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-700 transition-colors">
                                        <i class="fa fa-file-export"></i> Exportar CSV
                                    </button>
                                    <button onclick="addNewDeviceRow()" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700 transition-colors">
                                        <i class="fa fa-plus"></i> Añadir Dispositivo
                                    </button>
                                    <button onclick="loadBuildingDevices(currentBuildingId)" class="text-xs text-blue-600 hover:underline"><i class="fa fa-sync"></i> Refrescar</button>
                                </div>
                            </div>
                            <div class="bg-white border rounded shadow overflow-hidden overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200 text-sm">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-3 py-2 text-left font-medium text-gray-500">ID</th>
                                            <th class="px-3 py-2 text-left font-medium text-gray-500">Tipo</th>
                                            <th class="px-3 py-2 text-left font-medium text-gray-500 w-20">Nº</th>
                                            <th class="px-3 py-2 text-left font-medium text-gray-500">Planta</th>
                                            <th class="px-3 py-2 text-left font-medium text-gray-500">Ubicación</th>
                                            <th class="px-3 py-2 text-right font-medium text-gray-500 w-24">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="building-devices-table" class="divide-y divide-gray-200 bg-white">
                                        <tr><td colspan="6" class="px-3 py-4 text-center text-gray-400">Cargando...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;

                    // Start loading devices
                    loadBuildingDevices(id);

                    // Setup Drag and Drop for Config
                    setTimeout(() => {
                        const dropZoneConfig = document.getElementById('drop-zone-config');
                        if (dropZoneConfig) {
                            dropZoneConfig.addEventListener('dragover', (e) => {
                                e.preventDefault();
                                dropZoneConfig.classList.add('border-blue-500', 'bg-blue-50');
                            });
                            dropZoneConfig.addEventListener('dragleave', (e) => {
                                e.preventDefault();
                                dropZoneConfig.classList.remove('border-blue-500', 'bg-blue-50');
                            });
                            dropZoneConfig.addEventListener('drop', (e) => {
                                e.preventDefault();
                                dropZoneConfig.classList.remove('border-blue-500', 'bg-blue-50');
                                if (e.dataTransfer.files.length) {
                                    const fakeInput = { files: e.dataTransfer.files, value: 'dragged' };
                                    handleConfigUpload(fakeInput);
                                }
                            });
                        }
                    }, 0);
                }

            } catch (e) { console.error(e); }
        }

        // [NEW] Helper Functions for Device Table
        window.loadBuildingDevices = async function (buildingId) {
            const tbody = document.getElementById('building-devices-table');
            if (!tbody) return;
            tbody.innerHTML = '<tr><td colspan="6" class="px-3 py-4 text-center text-gray-400"><i class="fa fa-spinner fa-spin"></i> Cargando dispositivos...</td></tr>';

            try {
                const devices = await api.getDevicesByBuilding(buildingId);
                if (devices.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="px-3 py-4 text-center text-gray-400">No hay dispositivos registrados</td></tr>';
                    return;
                }

                // Sort by ID naturally
                devices.sort((a, b) => (parseInt(a.n) || 0) - (parseInt(b.n) || 0));

                tbody.innerHTML = devices.map(d => `
                    <tr id="row-dev-${d.db_id}" class="hover:bg-gray-50">
                        <td class="px-3 py-2 whitespace-nowrap text-gray-600 font-mono text-xs">${d.id}</td>
                        <td class="px-3 py-2 whitespace-nowrap">
                            <span class="px-2 py-0.5 rounded text-xs font-medium ${d.t === 'detector' ? 'bg-orange-100 text-orange-800' : 'bg-gray-100 text-gray-800'}">
                                ${d.t}
                            </span>
                        </td>
                        <td class="px-3 py-2 text-gray-900">${d.n || '-'}</td>
                        <td class="px-3 py-2 text-gray-500 text-xs">${d.floor_name || 'Desconocido'}</td>
                        <td class="px-3 py-2 text-gray-500 truncate max-w-xs" title="${d.loc}">${d.loc || ''}</td>
                        <td class="px-3 py-2 text-right text-xs font-medium">
                            <button onclick="enableEditDevice(${d.db_id})" class="text-blue-600 hover:text-blue-900 mr-2">Editar</button>
                            <button onclick="deleteDeviceItem(${d.db_id})" class="text-red-600 hover:text-red-900"><i class="fa fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('');

                // Store mapped data for edit reference if needed, or just rely on DOM for simple edits?
                // For robust editing, I should attach data to the row or fetch again via inputs.
                // I'll assume currentBuildingDevices global is safer if I store it.
                window.currentBuildingDevices = devices;

            } catch (e) {
                console.error('Error loading devices:', e);
                tbody.innerHTML = `<tr><td colspan="6" class="px-3 py-4 text-center text-red-500">Error: ${e.message}</td></tr>`;
            }
        };

        window.enableEditDevice = function (dbId) {
            const device = window.currentBuildingDevices.find(d => d.db_id === dbId);
            if (!device) return;

            const row = document.getElementById(`row-dev-${dbId}`);
            if (!row) return;

            // Generate floor options
            const floorOpts = currentBuildingFloors.map(f => `<option value="${f.id}" ${f.id === device.floor_id ? 'selected' : ''}>${f.name}</option>`).join('');

            row.innerHTML = `
                <td class="px-3 py-2"><input type="text" id="edit-id-${dbId}" value="${device.id}" class="w-full border-gray-300 rounded text-xs p-1"></td>
                <td class="px-3 py-2">
                     <select id="edit-type-${dbId}" class="w-full border-gray-300 rounded text-xs p-1">
                        <option value="detector" ${device.t === 'detector' ? 'selected' : ''}>Detector</option>
                        <option value="pulsador" ${device.t === 'pulsador' ? 'selected' : ''}>Pulsador</option>
                        <option value="sirena" ${device.t === 'sirena' ? 'selected' : ''}>Sirena</option>
                        <option value="modulo" ${device.t === 'modulo' ? 'selected' : ''}>Módulo</option>
                        <option value="central" ${device.t === 'central' ? 'selected' : ''}>Central</option>
                    </select>
                </td>
                <td class="px-3 py-2"><input type="text" id="edit-n-${dbId}" value="${device.n || ''}" class="w-full border-gray-300 rounded text-xs p-1"></td>
                <td class="px-3 py-2">
                    <select id="edit-floor-${dbId}" class="w-full border-gray-300 rounded text-xs p-1">
                        ${floorOpts}
                    </select>
                </td>
                <td class="px-3 py-2"><input type="text" id="edit-loc-${dbId}" value="${device.loc || ''}" class="w-full border-gray-300 rounded text-xs p-1"></td>
                <td class="px-3 py-2 text-right text-xs">
                    <button onclick="saveDeviceItem(${dbId})" class="text-green-600 hover:text-green-900 mr-2 font-bold"><i class="fa fa-check"></i></button>
                    <button onclick="loadBuildingDevices(currentBuildingId)" class="text-gray-500 hover:text-gray-700"><i class="fa fa-times"></i></button>
                </td>
            `;
        };

        window.saveDeviceItem = async function (dbId) {
            try {
                const updates = {
                    id: document.getElementById(`edit-id-${dbId}`).value,
                    t: document.getElementById(`edit-type-${dbId}`).value,
                    n: document.getElementById(`edit-n-${dbId}`).value,
                    loc: document.getElementById(`edit-loc-${dbId}`).value,
                    floorId: document.getElementById(`edit-floor-${dbId}`).value
                };

                await api.updateDevice(dbId, updates);
                loadBuildingDevices(currentBuildingId); // Reload to formatted view
            } catch (e) {
                alert('Error guardando cambios');
                console.error(e);
            }
        };

        window.addNewDeviceRow = function () {
            const tbody = document.getElementById('building-devices-table');
            if (!tbody) return;

            // Remove empty message if any
            if (tbody.innerHTML.includes('No hay dispositivos') || tbody.innerHTML.includes('Cargando')) {
                tbody.innerHTML = '';
            }

            const floorOpts = currentBuildingFloors.map(f => `<option value="${f.id}">${f.name}</option>`).join('');

            const newRow = document.createElement('tr');
            newRow.className = 'bg-blue-50/50';
            newRow.id = 'row-new-device';

            newRow.innerHTML = `
                <td class="px-3 py-2"><input type="text" id="new-id" placeholder="ID (ej: 101)" class="w-full border-gray-300 rounded text-xs p-1"></td>
                <td class="px-3 py-2">
                     <select id="new-type" class="w-full border-gray-300 rounded text-xs p-1">
                        <option value="detector">Detector</option>
                        <option value="pulsador">Pulsador</option>
                        <option value="sirena">Sirena</option>
                        <option value="modulo">Módulo</option>
                        <option value="central">Central</option>
                    </select>
                </td>
                <td class="px-3 py-2"><input type="text" id="new-n" placeholder="Nº" class="w-full border-gray-300 rounded text-xs p-1"></td>
                <td class="px-3 py-2">
                    <select id="new-floor" class="w-full border-gray-300 rounded text-xs p-1">
                        ${floorOpts}
                    </select>
                </td>
                <td class="px-3 py-2"><input type="text" id="new-loc" placeholder="Ubicación" class="w-full border-gray-300 rounded text-xs p-1"></td>
                <td class="px-3 py-2 text-right text-xs">
                    <button onclick="saveNewDeviceRow()" class="text-green-600 hover:text-green-900 mr-2 font-bold"><i class="fa fa-save"></i></button>
                    <button onclick="loadBuildingDevices(currentBuildingId)" class="text-gray-500 hover:text-gray-700"><i class="fa fa-times"></i></button>
                </td>
            `;

            tbody.prepend(newRow);
        };

        window.saveNewDeviceRow = async function () {
            try {
                const device = {
                    id: document.getElementById('new-id').value.trim(),
                    t: document.getElementById('new-type').value,
                    n: document.getElementById('new-n').value.trim(),
                    loc: document.getElementById('new-loc').value.trim(),
                    floorId: document.getElementById('new-floor').value,
                    x: 0,
                    y: 0
                };

                if (!device.id || !device.floorId) {
                    return alert('ID y Planta son obligatorios');
                }

                await api.createDevice(device);
                loadBuildingDevices(currentBuildingId);
            } catch (e) {
                alert('Error creando dispositivo');
                console.error(e);
            }
        };

        window.deleteDeviceItem = async function (dbId) {
            if (!confirm('¿Eliminar este dispositivo?')) return;

            const row = document.getElementById(`row-dev-${dbId}`);
            if (row) row.style.opacity = '0.5'; // Visual cue

            try {
                const res = await api.deleteDevice(dbId);
                if (res && res.success) {
                    // Remove from table immediately
                    if (row) row.remove();
                    // Also refresh data to be sure
                    loadBuildingDevices(currentBuildingId);
                } else {
                    alert('No se pudo eliminar el dispositivo. Verifique permisos.');
                    if (row) row.style.opacity = '1';
                }
            } catch (e) {
                console.error('Delete error:', e);
                alert('Error de conexión al eliminar');
                if (row) row.style.opacity = '1';
            }
        };

        window.exportDevicesToCSV = function () {
            if (!window.currentBuildingDevices || window.currentBuildingDevices.length === 0) {
                return alert('No hay dispositivos para exportar');
            }

            const buildingName = document.getElementById('selected-building-name').innerText;
            const headers = ['id', 'tipo', 'numero', 'planta', 'ubicacion', 'x', 'y'];

            const rows = window.currentBuildingDevices.map(d => [
                d.id,
                d.t,
                d.n,
                d.floor_name,
                `"${d.loc || ''}"`, // Wrap in quotes to handle commas
                d.x,
                d.y
            ]);

            const csvContent = [
                headers.join(','),
                ...rows.map(r => r.join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', `dispositivos_${buildingName.replace(/\s+/g, '_')}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        window.handleDeleteFloor = async function (id, evt) {
            try {
                console.log('[1] handleDeleteFloor called, id:', id);
                console.log('[2] Event:', evt);

                if (evt && typeof evt.stopPropagation === 'function') {
                    evt.stopPropagation();
                    console.log('[3] Stopped propagation');
                }

                console.log('[4] Proceeding with deletion (confirm dialog removed - was being blocked)');

                console.log('[5] Calling api.deleteFloor with id:', id);
                const res = await api.deleteFloor(id);
                console.log('[6] API response:', res);

                console.log('[7] Reloading floors...');
                await loadFloorsForBuilding(currentBuildingId);
                console.log('[8] Success! Floor deleted.');

            } catch (err) {
                console.error('[ERROR] Exception in handleDeleteFloor:', err);
                console.error('[ERROR] Stack:', err.stack);
                alert('Error eliminando planta: ' + err.message);
            }
        };

        // Drag & Drop Logic
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');

        console.log('Init Plans Logic:', { dropZone, fileInput });

        dropZone.onclick = () => {
            console.log('DropZone clicked');
            fileInput.click();
        };

        dropZone.ondragover = (e) => {
            e.preventDefault();
            dropZone.classList.add('bg-blue-50', 'border-blue-400');
        };

        dropZone.ondragleave = () => {
            dropZone.classList.remove('bg-blue-50', 'border-blue-400');
        };

        dropZone.ondrop = (e) => {
            console.log('File Dropped');
            e.preventDefault();
            dropZone.classList.remove('bg-blue-50', 'border-blue-400');
            if (e.dataTransfer.files.length) {
                console.log('Files found in drop:', e.dataTransfer.files);
                handleFileUpload(e.dataTransfer.files[0]);
            }
        };

        fileInput.onchange = (e) => {
            console.log('FileInput changed', e.target.files);
            if (e.target.files.length) handleFileUpload(e.target.files[0]);
        };

        async function handleFileUpload(file) {
            console.log('Handling file upload:', file.name);
            // Reset input so change event fires even if same file is selected again
            document.getElementById('file-input').value = '';

            if (!currentBuildingId) return alert('Selecciona un edificio primero');

            // Get name from input or default to filename
            const inputName = document.getElementById('new-floor-name').value.trim();
            const defaultName = file.name.split('.')[0].replace(/[-_]/g, ' ');
            const name = inputName || defaultName;

            console.log('Using name:', name);

            // Check for duplicate name
            const existing = currentBuildingFloors.find(f => f.name.toLowerCase() === name.toLowerCase());
            if (existing) {
                if (!confirm(`Ya existe una planta llamada "${name}".\n\n¿Estás seguro de que quieres sustituir el plano ? `)) {
                    document.getElementById('file-input').value = '';
                    return;
                }
                // If yes, delete old one first
                try {
                    await api.deleteFloor(existing.id);
                } catch (e) {
                    console.error('Error deleting old floor:', e);
                    return alert('Error al sustituir la planta anterior.');
                }
            }

            try {
                // Show loading state (could be improved)
                dropZone.innerHTML = '<i class="fa fa-spinner fa-spin text-4xl text-blue-500"></i><p class="mt-2">Subiendo...</p>';

                await api.uploadFloor(currentBuildingId, name, file);

                // Reset Drop Zone
                dropZone.innerHTML = `
                    <i class="fa fa-cloud-upload-alt text-4xl text-blue-400 mb-2"></i>
                    <p class="font-medium text-gray-600">Arrastra aquí el plano de la nueva planta</p>
                    <p class="text-xs text-gray-400 mt-1">o haz click para seleccionar (JPG, PNG)</p>
                `;

                // Refresh list
                loadFloorsForBuilding(currentBuildingId);
                document.getElementById('new-floor-name').value = ''; // Clear input
                alert('Plano subido correctamente!');
            } catch (e) {
                alert('Error subiendo el plano: ' + e.message);
                // Reset drop zone text just in case
                dropZone.innerHTML = `<p class="text-red-500">Error. Refresca la página.</p>`;
            }
        }

        window.handleConfigUpload = async function (input) {
            const file = input.files[0];
            if (!file) return;

            if (!confirm(`¿Seguro que deseas cargar "${file.name}" ? Esto sobrescribirá los dispositivos de este edificio.`)) {
                input.value = '';
                return;
            }

            // Show loading
            const box = document.getElementById('drop-zone-config');
            const originalContent = box.innerHTML;
            box.innerHTML = '<div class="py-4"><i class="fa fa-circle-notch fa-spin text-blue-500 text-2xl"></i><p class="text-xs text-blue-500 mt-2 font-bold">Procesando archivo...</p></div>';

            try {
                const res = await api.uploadBuildingConfig(currentBuildingId, file);
                if (res.success) {
                    alert(`Importación completada: \n - Insertados: ${res.insertedCount} \n - Omitidos: ${res.skippedCount}`);
                    // Optionally reload floors/devices view if we had one visible
                } else {
                    alert('Error en la importación');
                }
            } catch (e) {
                console.error(e);
                alert('Error al cargar la configuración: ' + e.message);
            } finally {
                box.innerHTML = originalContent;
                input.value = '';
            }
        };

        // Initial load - Load users since the Users tab is active by default
        loadUsers();
    </script>
    <!-- Footer -->
    <footer
        class="bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 py-4 mt-8 transition-colors duration-200">
        <div class="max-w-6xl mx-auto px-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <p class="text-xs text-gray-500 dark:text-gray-400">© 2025 Universidad Zaragoza. Todos los derechos
                reservados.</p>
            <p class="text-xs text-gray-500 dark:text-gray-400 font-medium">
                Desarrollado por Luis Enrique Seco <span class="text-gray-700 dark:text-gray-300 font-bold">UNIDAD DE
                    SEGURIDAD</span>
            </p>
        </div>
    </footer>
</body>

</html>